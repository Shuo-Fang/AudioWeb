<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('修改终端管理')" />
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <form class="form-horizontal m" id="form-terminal-edit" th:object="${workTerminal}">
            <input name="terRealId" th:field="*{terRealId}" type="hidden">
            <input name="domainId" th:field="*{domainId}" type="hidden">
            <input name="precinct" type="hidden" id="precinct" th:field="*{precinct}"/>
            <div class="form-group">    
        		<label class="col-sm-3 control-label">终端状态：</label>
                <div class="col-sm-8">
                	<label class="toggle-switch switch-solid">
                            <input type="checkbox" id="status" th:checked="*{status == '0' ? true : false}">
                            <span></span>
                    </label>
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label is-required">终端ID：</label>
                <div class="col-sm-8">
                    <input name="terminalId" th:field="*{terminalId}" class="form-control" type="text" placeholder="请输入终端ID" required>
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label is-required">终端名称：</label>
                <div class="col-sm-8">
                    <input name="terminalName" th:field="*{terminalName}" class="form-control" type="text" placeholder="请输入终端名称" required>
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label is-required">IP：</label>
                <div class="col-sm-8">
                    <input name="terminalIp" th:field="*{terminalIp}" class="form-control" placeholder="请输入IP地址" required>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label is-required">所属分区：</label>
                <div class="col-sm-8">
                    <div class="input-group">
                    	<input name="domainName" onclick="selectDomainTree()" id="treeName" type="text" placeholder="请选择归属分区" class="form-control" readonly="true" th:field="*{domain.domainName}" required>
                        <span class="input-group-addon" onclick="selectDomainTree()"><i class="fa fa-search"></i></span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">寻呼话筒：</label>
                <div class="col-sm-2">
               		<label class="toggle-switch switch-solid">
                            <input type="checkbox" id="isCmic" onclick="showSelect();" th:checked="*{isCmic == '0' ? true : false}">
                            <span></span>
                    </label>
                </div>
                <label class="col-sm-3 control-label">自动采播：</label>
                <div class="col-sm-2">
                	<label class="toggle-switch switch-solid">
                            <input type="checkbox" id="isAutoCast" onclick="showSelect();" th:checked="*{isAutoCast == '0' ? true : false}">
                            <span></span>
                    </label>
                </div>
            </div>
            <div class="form-group" id= "domainSelect">
                <label class="col-sm-3 control-label is-required">终端管理分区：</label>
                <div class="col-sm-8">
                    <div class="input-group">
                    	<input name="domainNames" onclick="selectDomainTrees()" id="domainNames" type="text" placeholder="请选择管理的分区" class="form-control" readonly="true" th:value="*{delFlag}" required>
                        <span class="input-group-addon" onclick="selectDomainTrees()"><i class="fa fa-search"></i></span>
                    </div>
                </div>
            </div>
            <h4 class="form-header h4">其他信息</h4>
            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">备注：</label>
                        <div class="col-sm-8">
                            <textarea name="remark" maxlength="500" class="form-control" rows="3" th:field="*{remark}"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <th:block th:include="include :: footer" />
    <script type="text/javascript">
        var prefix = ctx + "system/terminal";
        $(function() {
        	showSelect();
        });
        $("#form-terminal-edit").validate({
        	onkeyup: false,
        	rules:{
        		terminalName:{
        			minlength: 2,
        			maxlength: 30
        		},
        		terminalId:{
        			minlength: 4,
        			maxlength: 4,
        			remote: {
                        url: prefix + "/checkIdUnique",
                        type: "post",
                        dataType: "json",
                        data: {
                            "terminalId": function () {
                            	var data = $("input[name='terminalId']").val();
                                return data;
                            },
                            "terRealId":$("input[name='terRealId']").val()
                        },
                        dataFilter: function (data, type) {
                        	return $.validate.unique(data);
                        }
                    }
        		},
        		terminalIp:{
        			isIp:true,
        			remote: {
                        url: prefix + "/checkIpUnique",
                        type: "post",
                        dataType: "json",
                        data: {
                            "terminalIp": function () {
                            	var data = $("input[name='terminalIp']").val();
                                return data;
                            },
                            "terRealId":$("input[name='terRealId']").val()
                        },
                        dataFilter: function (data, type) {
                        	return $.validate.unique(data);
                        }
                    }
        		},
        	},
        	messages: {
        		"terminalIp": {
                    remote: "IP地址输入出错或已存在"
                },
        		"terminalId": {
                    remote: "终端ID地址输入出错或已存在"
                }
            },
            focusCleanup: true
        });

        function submitHandler() {
            if ($.validate.form()) {
	        	var data = $("#form-terminal-edit").serializeArray();
	        	var status = $("input[id='status']").is(':checked') == true ? 0 : 1;
	        	var isCmic = $("input[id='isCmic']").is(':checked') == true ? 0 : 1;
	        	var isAutoCast = $("input[id='isAutoCast']").is(':checked') == true ? 0 : 1;
	        	data.push({"name": "status", "value": status});
	        	data.push({"name": "isCmic", "value": isCmic});
	        	data.push({"name": "isAutoCast", "value": isAutoCast});
                $.operate.save(prefix + "/edit", data);
            }
        }
        /*选择分区树*/
        function selectDomainTree() {
        	var domainId = $("#domainId").val();
        	domainId = $.common.isEmpty(domainId) ? "0" : $("#domainId").val();
        	var url = ctx + "system/domain/selectDomainTree/" + domainId;
			var options = {
				title: '选择分区',
				width: "380",
				url: url,
				callBack: doSubmit
			};
			$.modal.openOptions(options);
		}

        function doSubmit(index, layero){
			//var tree = layero.find("iframe")[0].contentWindow.$._tree;
        	var body = layer.getChildFrame('body', index);
			$("#precinct").val(body.find('#treeIds').val());
			$("#domainNames").val(body.find('#treeNames').val());
			layer.close(index);
		}		
        /*复选分区树*/
        function selectDomainTrees(){
        	var domainIds = $.common.isEmpty($("#precinct").val()) ? "0" : $("#precinct").val();
        	var url = ctx + "system/domain/selectDomainTrees/" + domainIds;
			var options = {
				title: '选择分区',
				width: "380",
				url: url,
				callBack: getDomainIds
			};
			$.modal.openOptions(options);
        }
		
        function getDomainIds(index, layero){
			var tree = layero.find("iframe")[0].contentWindow.$._tree;
			if (tree.getCheckedNodes() && tree.getCheckedNodes().length > 0) {
				var ters = formatMulTree(tree.getCheckedNodes());
    			$("#precinct").val(ters.precinct);
    			$("#domainNames").val(ters.domainNames);
    			layer.close(index);
			}else{
				$.modal.msgError("请选择对应分区");
			}
		}
        //处理按钮点击,显示分区选择
		function showSelect(){
			var is = $("input[id='isAutoCast']").is(':checked')||$("input[id='isCmic']").is(':checked');
			if(is){
				$("#domainSelect").show();
			}else{
				$("#domainSelect").hide();
			}
		}
    </script>
</body>
</html>